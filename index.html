<!DOCTYPE html>
<!-- Run this file with: python index.html -->
<script>
/*
Note: This file contains a Python Flask app below. Save as index.html and run:
    python index.html
It will start a local server and serve the HTML UI.

The HTML UI returned by Flask is defined inside the Python app below.
*/
</script>
# -*- coding: utf-8 -*-
import base64
import io
import os
from flask import Flask, request, render_template_string
from PIL import Image, ImageOps, ImageFilter
import pytesseract

app = Flask(__name__)

HTML_TEMPLATE = """
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CAPTCHA OCR Decoder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { color-scheme: light dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 2rem; }
  .container { max-width: 820px; margin: 0 auto; }
  h1 { font-size: 1.6rem; margin: 0 0 1rem; }
  p.helper { color: #666; margin-top: 0; }
  form { border: 1px solid #ccc; border-radius: 10px; padding: 1rem; }
  .row { display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
  .actions { margin-top: 1rem; display: flex; gap: .75rem; flex-wrap: wrap; }
  input[type=file] { padding: .5rem; }
  button { padding: .6rem 1rem; border-radius: 8px; border: 1px solid #888; background: #1a73e8; color: #fff; cursor: pointer; }
  button.secondary { background: transparent; color: inherit; }
  .result { margin-top: 1rem; padding: 1rem; border-radius: 10px; background: #f2f6ff; border: 1px solid #cfe0ff; }
  .result h2 { margin-top: 0; font-size: 1.2rem; }
  .preview { margin-top: 1rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; align-items: start; }
  .card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; }
  .card header { padding: .5rem .75rem; font-weight: 600; background: #fafafa; border-bottom: 1px solid #eee; }
  .card .body { padding: .75rem; }
  img.preview-img { display: block; max-width: 100%; height: auto; }
  .error { color: #b00020; margin-top: .75rem; }
  footer { margin-top: 2rem; color: #777; font-size: .9rem; }
  code.kbd { padding: .1rem .3rem; border: 1px solid #ccc; border-radius: 4px; background: #f7f7f7; }
</style>
</head>
<body>
<div class="container">
  <h1>CAPTCHA OCR Decoder</h1>
  <p class="helper">Upload a CAPTCHA image; the server will preprocess it and run OCR using Python pytesseract to extract the text.</p>

  <form action="/" method="post" enctype="multipart/form-data">
    <div class="row">
      <input type="file" name="image" accept="image/*" required>
    </div>
    <div class="actions">
      <button type="submit">Decode CAPTCHA</button>
      <button type="reset" class="secondary">Reset</button>
    </div>
    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}
  </form>

  {% if text is not none %}
    <div class="result">
      <h2>Decoded Text</h2>
      <div><strong>Result:</strong> <span style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">{{ text if text.strip() else "(no text detected)" }}</span></div>
    </div>
  {% endif %}

  {% if orig_b64 or proc_b64 %}
  <div class="preview">
    {% if orig_b64 %}
    <div class="card">
      <header>Original Image</header>
      <div class="body">
        <img class="preview-img" src="data:image/png;base64,{{ orig_b64 }}" alt="Original upload">
      </div>
    </div>
    {% endif %}
    {% if proc_b64 %}
    <div class="card">
      <header>Preprocessed Image</header>
      <div class="body">
        <img class="preview-img" src="data:image/png;base64,{{ proc_b64 }}" alt="Preprocessed for OCR">
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <footer>
    Powered by Flask, Pillow, and pytesseract. For best results, upload a clear, single-line CAPTCHA with minimal background noise.
  </footer>
</div>
</body>
</html>
"""

def preprocess_for_captcha(img: Image.Image) -> Image.Image:
    # Convert to grayscale
    g = img.convert("L")
    # Light denoise
    g = g.filter(ImageFilter.MedianFilter(size=3))
    # Increase contrast
    g = ImageOps.autocontrast(g)
    # Binarize with a reasonable threshold
    bw = g.point(lambda x: 0 if x < 140 else 255, mode="1")
    # Convert back to 8-bit after binarization for pytesseract
    return bw.convert("L")

def to_base64_png(img: Image.Image) -> str:
    buf = io.BytesIO()
    img.save(buf, format="PNG")
    return base64.b64encode(buf.getvalue()).decode("ascii")

@app.route("/", methods=["GET", "POST"])
def index():
    text = None
    error = None
    orig_b64 = None
    proc_b64 = None

    if request.method == "POST":
        file = request.files.get("image")
        if not file or file.filename == "":
            error = "Please choose an image file before submitting."
        else:
            try:
                img = Image.open(file.stream).convert("RGB")
                orig_b64 = to_base64_png(img)

                proc = preprocess_for_captcha(img)

                # OCR configuration tailored for CAPTCHAs: single line, whitelist alphanumerics
                config = "--oem 3 --psm 7 -c tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
                text = pytesseract.image_to_string(proc, config=config).strip()
                proc_b64 = to_base64_png(proc)
            except Exception as e:
                error = f"Failed to process image: {e}"

    return render_template_string(HTML_TEMPLATE, text=text, error=error, orig_b64=orig_b64, proc_b64=proc_b64)

if __name__ == "__main__":
    # Optional: respect PORT env var
    port = int(os.environ.get("PORT", "5000"))
    app.run(host="0.0.0.0", port=port, debug=False)